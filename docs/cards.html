<!DOCTYPE html>
<html>
	<head>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
		<script src="http://localhost:8080/socket.io/socket.io.js"></script>
		<script src='https://cloud.tinymce.com/stable/tinymce.min.js'></script>

		<style>
			.output {
				width:1280px;
				height:720px;
				background:blue;
			}
			.textinput1 {
				width:280px;
			}
			.card {
				background:red;
				position:absolute;
				width:128px;
				height:72px;
			}
			.inner {
				background:green;
			}
			.hidden {
				visibility: hidden;
			}
		</style>
		<script>
			tinymce.init({
				selector: '#mytextarea',
				plugins: "textcolor colorpicker",
				menubar: false,
				toolbar: "bold italic underline strikethrough fontsizeselect fontselect forecolor backcolor",
				fontsize_formats: '8pt 10pt 12pt 14pt 18pt 24pt 36pt 40pt 50pt 60pt 70pt 80pt',
				init_instance_callback: function (editor) {
					editor.on('KeyUp', function (e) {
						$("#cardtext").val(editor.getContent());
						if($("#"+active_card)){
							$("#"+active_card+" div.inner").html($("#cardtext").val());
							socket.emit('card','content',[active_card,$("#cardtext").val()]);	
						}
					});
					editor.on('Change', function (e) {
						$("#cardtext").val(editor.getContent());
						if($("#"+active_card)){
							$("#"+active_card+" div.inner").html($("#cardtext").val());
							socket.emit('card','content',[active_card,$("#cardtext").val()]);	
						}
					});
				}
			});
			var socket = io.connect('http://localhost:8080');
			socket.on('conn', function () {
				socket.emit('card','getCards');
			});
			var cardid = Math.round((new Date).getTime());
			var active_card;
				
			function add_card(id) {

				$( "#output" ).append($( "<div id='"+id+"' class='card hidden'><div class='inner'>"+(id)+"</div></div>" ));
				
				
				$( "#"+id).css( { left:100, top: 100 } );
				
				$( "#"+id).draggable();
				$( "#"+id).resizable();
				
				$( "#"+id).click(function() {
				
					set_active_card(this.id);
				});
					
				
				$( "#"+id).on( "drag", function( event, ui ) { 
			
					socket.emit('card','move',[id,$("#"+id).offset().left,$("#"+id).offset().top]);
				
				} );	
				$( "#"+id).on( "resize", function( event, ui ) { 
				
					socket.emit('card','resize',[id,ui.size.width,ui.size.height]);
				
				} );	
			}

			function set_active_card(id){

				active_card = id;
				$("#active_id").text(id);
				$("#cardtext").val($("#"+active_card+" div").html());
				tinymce.activeEditor.setContent($("#"+active_card+" div").html());
			}

			socket.on('card', function(item,value){
		
				console.log(value+'');

				if(item == 'add')
					add_card(value)
				else if(item == 'move')
					$( "#"+value[0]).css( { left:value[1], top: value[2] } )
				else if(item == 'resize')
					$( "#"+value[0]).css( { width:value[1], height: value[2] } )
				else if(item == 'clear')
					$(".card").each(function( index ) {this.remove();})
				else if(item == 'del')
					$("#"+value[0]).remove();
				else if(item == 'content')
					$("#"+value[0]+" div.inner").html(value[1])
				else if(item == 'show')
					$("#"+value).removeClass('hidden');
				else if(item == 'oemb'){
					$.getJSON( value[1], {format: "json"}).done(function( data ) {
						data.html = data.html.replace(/\"\/\//g,'"http://');
						$("#"+value[0]+" div.inner").html($(data.html));
					});
				}
				else if(item == 'getCards'){
					$(".card").each(function( index ) {
						socket.emit('card','add',this.id);
						socket.emit('card','show',this.id);
						socket.emit('card','content',[this.id,$("#"+this.id+" div.inner").html()]);
						socket.emit('card','move',[this.id,$("#"+this.id).offset().left,$("#"+this.id).offset().top]);
					})
				}

			});

		</script>
	</head>

	<body>

		<div id="output" class="output">
		</div>


		<button id="addCard" class="ui-button ui-widget ui-corner-all">Add</button>
		<button id="clearCards" class="ui-button ui-widget ui-corner-all">Clear</button>
		

		<div>Active Card: <span id="active_id"/></div>
		
		<button id="delActiveCard" class="ui-button ui-widget ui-corner-all">Delete Active Card</button>
		<button id="showActiveCard" class="ui-button ui-widget ui-corner-all">Show Active Card</button>
	
		<input type="text" id="cardtext" class="textinput1"/>
		<button id="updateText" class="ui-button ui-widget ui-corner-all">Set</button>
		<button id="updateTweet" class="ui-button ui-widget ui-corner-all">SetTweet</button>

<textarea id="mytextarea">Hello, World!</textarea>

		<script>
			$( "#addCard" ).click(function() {


				socket.emit('card','add','card_'+cardid);
				
				add_card('card_'+cardid);
				var id = cardid;
				
				
				$( "#card_"+cardid).removeClass('hidden');

				cardid++;

			});
			$( "#clearCards" ).click(function() {
				$(".card").each(function( index ) {this.remove();});
				socket.emit('card','clear');
			});
			$( "#delActiveCard" ).click(function() {
				$("#"+active_card).remove();
				socket.emit('card','del',active_card);
			});
			$( "#showActiveCard" ).click(function() {
				socket.emit('card','show',active_card);
			});
			$( "#updateText" ).click(function() {
				if($("#"+active_card)){
					$("#"+active_card+" div.inner").html($("#cardtext").val());
					
					socket.emit('card','content',[active_card,$("#cardtext").val()]);	
				}
			});
			
			$( "#updateTweet" ).click(function() {

				var oembUrl = "https://publish.twitter.com/oembed?maxwidth=550&url="+$("#cardtext").val();
					
				socket.emit('card','oemb',[active_card,oembUrl]);	

				$.getJSON( oembUrl, {format: "json"}).done(function( data ) {
					data.html = data.html.replace(/\"\/\//g,'"http://');
					$("#"+active_card+" div.inner").html($(data.html));
				});
			});

		</script>
	</body>
</html>


