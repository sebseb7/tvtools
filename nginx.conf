
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    ##sendfile off;
    #tcp_nopush on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   html;
            index  index.html index.htm;
        }
        location /rec {
            root   html/rec;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
	
	
	location /stat {
		rtmp_stat all;		
	}
	

    }


    
   server {
       listen       443 ssl;
       server_name  localhost;

#        ssl_certificate      cert.pem;
#        ssl_certificate_key  cert.key;
ssl_certificate /etc/letsencrypt/live/xxxxxxxxxxxxxx/fullchain.pem;
ssl_certificate_key  /etc/letsencrypt/live/xxxxxxxxxxxxxx/privkey.pem;

        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;

        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        location / {
            root   html;
            index  index.html index.htm;
        }
	location /stat {
		rtmp_stat all;		
	}
	
	location /mytv2 {
       # Serve HLS fragments
       types {
    	application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }
     root /tmp;
     add_header Cache-Control no-cache;
	 add_header Access-Control-Allow-Origin *;	 
    }
    }
}
#rtmp_auto_push on;

rtmp {

	server {

		listen 1935;
#		buflen 5s;
#		chunk_size 4096;
#			play_restart on;
#		chunk_size 256;
	
		application feed {

			live on;
			session_relay on;
			play_restart on;
			publish_notify on;
			
		}
		application jcyt {

			live on;
			
			push rtmp://a.rtmp.youtube.com/live2/xxxxxxxxxxxxxxxxxxxxxxxxxxxx;
			push rtmp://ingest-eu-ams.switchboard.zone/live/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;
			push rtmp://localhost/mytv/live;
		}
		application yt {

			live on;
			
			push rtmp://a.rtmp.youtube.com/live2/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;
			push rtmp://localhost/mytv/live;
		}
		application jc {

			live on;
			push rtmp://ingest-eu-ams.switchboard.zone/live/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;
			push rtmp://localhost/mytv/live;
		}
		application jc2 {

			live on;
			push rtmp://ingest-eu-ams.switchboard.zone/live/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;
			push rtmp://ingest-eu-central.a.switchboard.zone/live/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;
			push rtmp://localhost/mytv/live;
		}
		application fb {

			live on;
			push rtmp://rtmp-api.facebook.com:80/rtmp/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx;
			push rtmp://localhost/mytv/live;
		}
		
		application feed {

			live on;
			drop_idle_publisher 2s;
		#	play_restart on;
		#	publish_notify on;
			session_relay on;
		}

		application mytv {

			live on;
			play_restart on;
			drop_idle_publisher 2s;
			publish_notify on;
			session_relay on;
#			exec_publish bash -c "echo '$name $addr' > /tmp/log.log";
#			exec_publish_done bash -c "echo '$name $addr' > /tmp/log.log2";
			
	
			exec ffmpeg -i rtmp://localhost/mytv/$name -async 1 -vsync -1 
				#-c:v libx264 -c:a aac -b:v 56k  -b:a 56k  -s 284x160 -tune zerolatency -preset veryfast -crf 23 -f flv rtmp://localhost/mytv2/$name_56 
				#-c:v libx264 -c:a aac -b:v 300k -b:a 56k  -s 854x480 -tune zerolatency -preset veryfast -crf 23 -f flv rtmp://localhost/mytv2/$name_300 
				#-c:v libx264 -c:a aac -b:v 900k -b:a 128k -s 854x480 -tune zerolatency -preset veryfast -crf 23 -f flv rtmp://localhost/mytv2/$name_900 
				-c copy -f flv rtmp://localhost/mytv2/$name_src;
			

#			recorder rec1 {
#				record all;
#				record_interval 3600s;
#				record_path /opt/RECORDINGS;
#				record_unique on;
#			}

		}

		application mytv2 {

			live on;

			play_restart on;

			hls on;
			hls_path /tmp/mytv2;
			hls_continuous on;
			hls_nested on;

			allow publish 127.0.0.1;
			allow publish 0.0.0.0;
			deny publish all;

			#hls_variant _56 BANDWIDTH=112000; 
			#hls_variant _300 BANDWIDTH=356000; 
			#hls_variant _900 BANDWIDTH=1028000;
			hls_variant _src BANDWIDTH=15000000; 


		}


	}
}

